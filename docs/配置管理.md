# 配置管理说明

本文档详细说明 donkey-ucenter-backend 项目的配置管理机制，包括配置文件初始化、格式说明、读取顺序以及高级使用方式。

## 目录

- [项目配置文件初始化](#项目配置文件初始化)
- [项目配置采用格式](#项目配置采用格式)
- [项目读取配置文件的顺序](#项目读取配置文件的顺序)
- [其他高级使用方式](#其他高级使用方式)
- [Viper 支持的配置文件类型和读取顺序](#viper-支持的配置文件类型和读取顺序)

---

## 项目配置文件初始化

### 初始化步骤

1. **复制配置文件模板**

   项目提供了配置文件模板 `conf/config.toml.example`，首次使用时需要复制并重命名：

   ```bash
   cp conf/config.toml.example conf/config.toml
   ```

2. **编辑配置文件**

   根据实际环境编辑 `conf/config.toml`，配置数据库、Redis、SMTP 等服务信息。

3. **使用安装脚本自动初始化**

   如果使用 `install.sh` 安装脚本，配置文件会自动从模板初始化。

### 多环境配置支持

项目支持通过 `runmode` 参数指定不同的配置文件，实现多环境配置管理：

- **默认配置**: `config.toml`
- **指定环境**: `config_<runmode>.toml`

**使用示例：**

```bash
# 使用默认配置 config.toml
go run main.go

# 使用开发环境配置 config_dev.toml
go run main.go -runmode=dev

# 使用生产环境配置 config_prod.toml
go run main.go -runmode=prod
```

**配置文件命名规则：**
- 默认模式：`config.toml`
- 指定模式：`config_<runmode>.toml`（如 `config_dev.toml`、`config_prod.toml`）

---

## 项目配置采用格式

### TOML 格式

项目采用 **TOML (Tom's Obvious, Minimal Language)** 作为配置文件格式。TOML 是一种易于阅读和编写的配置文件格式，支持嵌套结构、数组、注释等特性。

### 配置文件结构

```toml
# MySQL 数据库配置
[mysql_default]
host = "127.0.0.1"
username = "root"
password = "123456"
port = "3306"
database = "donkey_user_center"
charset = "utf8mb4"

# Redis 缓存配置
[redis_default]
host = "127.0.0.1"
port = "6379"
password = "123456"
db = 1

# SMTP 邮件服务配置
[smtp]
host = "smtp.example.com"
port = 465
user = "noreply@example.com"
password = "your_password"
```

### 配置项说明

#### MySQL 配置 (`mysql_default`)

| 配置项 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `host` | string | 数据库主机地址 | `127.0.0.1` |
| `username` | string | 数据库用户名 | `root` |
| `password` | string | 数据库密码 | `123456` |
| `port` | string | 数据库端口 | `3306` |
| `database` | string | 数据库名称 | `donkey_user_center` |
| `charset` | string | 字符集 | `utf8mb4` |

#### Redis 配置 (`redis_default`)

| 配置项 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `host` | string | Redis 主机地址 | `127.0.0.1` |
| `port` | string | Redis 端口 | `6379` |
| `password` | string | Redis 密码 | `123456` |
| `db` | int | 数据库编号 | `1` |

#### SMTP 配置 (`smtp`)

| 配置项 | 类型 | 说明 | 示例 |
|--------|------|------|------|
| `host` | string | SMTP 服务器地址 | `smtp.example.com` |
| `port` | int | SMTP 端口 | `465` |
| `user` | string | 邮箱用户名 | `noreply@example.com` |
| `password` | string | 邮箱密码 | `your_password` |

---

## 项目读取配置文件的顺序

项目使用 [Viper](https://github.com/spf13/viper) 作为配置管理库，配置文件读取遵循以下顺序：

### 1. 文件系统读取（优先级最高）

Viper 会按以下路径顺序搜索配置文件：

1. **当前工作目录** (`.`)
   - 搜索 `config.toml` 或 `config_<runmode>.toml`

2. **conf 目录** (`./conf/`)
   - 搜索 `conf/config.toml` 或 `conf/config_<runmode>.toml`

3. **项目根目录**（通过 `runtime.Caller` 自动检测）
   - 自动检测项目根目录并搜索配置文件

**代码实现：**

```go
viper.SetConfigName(GetConfigNameByRunMode()) // 设置配置文件名
viper.AddConfigPath(".")                      // 当前工作目录
viper.AddConfigPath(path.Dir(filename))       // conf 目录
viper.AddConfigPath(path.Dir(path.Dir(filename))) // 项目根目录
```

### 2. 嵌入文件读取（备用方案）

如果文件系统中找不到配置文件，Viper 会从编译时嵌入的二进制文件中读取配置。

**代码实现：**

```go
// 使用 Go 1.16+ embed 功能
//go:embed config.toml config_*.toml
var embedConfig embed.FS

// 如果文件系统读取失败，从嵌入文件读取
if err := viper.ReadInConfig(); err != nil {
    viper.SetConfigType("toml")
    viper.ReadConfig(bytes.NewReader(GetEmbedConfigByRunMode()))
}
```

### 读取顺序总结

```
1. 文件系统读取（按路径顺序）:
   ├── ./config.toml (或 config_<runmode>.toml)
   ├── ./conf/config.toml (或 config_<runmode>.toml)
   └── <项目根目录>/config.toml (或 config_<runmode>.toml)

2. 嵌入文件读取（备用）:
   └── 从编译时嵌入的二进制文件中读取
```

**注意：** 一旦在文件系统中找到配置文件，就会立即使用，不会继续搜索其他路径。

---

## 其他高级使用方式

### 1. 环境变量覆盖

Viper 支持通过环境变量覆盖配置文件中的值。环境变量命名规则：

- 使用大写字母
- 使用下划线分隔
- 嵌套配置使用下划线连接

**示例：**

```bash
# 覆盖 MySQL 主机地址
export MYSQL_DEFAULT_HOST=192.168.1.100

# 覆盖 Redis 密码
export REDIS_DEFAULT_PASSWORD=newpassword

# 覆盖 SMTP 端口
export SMTP_PORT=587
```

**代码中启用环境变量：**

```go
viper.AutomaticEnv() // 自动读取环境变量
```

### 2. 命令行参数覆盖

项目支持通过命令行参数覆盖部分配置：

```bash
# 指定监听地址和端口
go run main.go -host=0.0.0.0 -port=8080

# 指定运行模式
go run main.go -runmode=prod

# 指定日志文件
go run main.go -logfile=/var/log/app.log -loglevel=info
```

**支持的命令行参数：**

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `-host` | 监听主机地址 | `0.0.0.0` |
| `-port` | 监听端口 | `8000` |
| `-root` | 项目根目录 | 空 |
| `-runmode` | 运行模式 | 空 |
| `-logfile` | 日志文件路径 | 标准输出 |
| `-loglevel` | 日志级别 | `error` |

### 3. 配置热重载（Watch）

Viper 支持配置文件热重载，当配置文件发生变化时自动重新加载：

```go
viper.WatchConfig()
viper.OnConfigChange(func(e fsnotify.Event) {
    fmt.Println("Config file changed:", e.Name)
    // 重新加载配置
})
```

### 4. 配置验证

在配置加载后，可以进行配置验证：

```go
// 验证必需的配置项
if Config.MysqlDefault.HOST == "" {
    panic("MySQL host is required")
}

if Config.MysqlDefault.DATABASE == "" {
    panic("MySQL database is required")
}
```

### 5. 配置默认值

可以在代码中设置配置默认值：

```go
viper.SetDefault("mysql_default.host", "127.0.0.1")
viper.SetDefault("mysql_default.port", "3306")
viper.SetDefault("redis_default.db", 0)
```

---

## Viper 支持的配置文件类型和读取顺序

### 支持的配置文件格式

Viper 支持多种配置文件格式，无需修改代码即可切换：

| 格式 | 扩展名 | 说明 |
|------|--------|------|
| **JSON** | `.json` | JavaScript Object Notation |
| **TOML** | `.toml` | Tom's Obvious, Minimal Language（本项目使用） |
| **YAML** | `.yaml`, `.yml` | YAML Ain't Markup Language |
| **HCL** | `.hcl` | HashiCorp Configuration Language |
| **envfile** | `.env` | 环境变量文件 |
| **Java Properties** | `.properties` | Java 属性文件 |
| **INI** | `.ini` | Windows INI 文件格式 |

### 设置配置文件类型

```go
// 显式指定配置文件类型
viper.SetConfigType("toml")  // 或 "yaml", "json" 等

// 或者通过文件扩展名自动识别
viper.SetConfigFile("config.toml")
```

### Viper 配置读取优先级（完整顺序）

Viper 按照以下优先级顺序读取配置，优先级从高到低：

```
1. 显式调用 Set 设置的值
   └── viper.Set("key", "value")

2. 命令行参数（Flag）
   └── viper.BindPFlag("key", flag)

3. 环境变量
   └── viper.AutomaticEnv()
   └── viper.BindEnv("key")

4. 配置文件
   ├── 显式指定的配置文件
   │   └── viper.SetConfigFile("config.toml")
   └── 搜索路径中的配置文件
       └── viper.AddConfigPath(".")

5. 键值存储（Key/Value Store）
   └── viper.Set("key", "value")

6. 默认值
   └── viper.SetDefault("key", "default")
```

### 配置读取示例

```go
// 1. 设置默认值（最低优先级）
viper.SetDefault("database.host", "localhost")

// 2. 读取配置文件（会被环境变量和命令行参数覆盖）
viper.ReadInConfig()

// 3. 绑定环境变量
viper.BindEnv("database.host", "DB_HOST")

// 4. 绑定命令行参数
viper.BindPFlag("database.host", flag.Lookup("db-host"))

// 5. 显式设置（最高优先级）
viper.Set("database.host", "explicit-value")

// 读取配置（按优先级返回）
host := viper.GetString("database.host")
```

### 多配置文件支持

Viper 支持读取多个配置文件，后读取的配置会覆盖先读取的配置：

```go
// 读取主配置文件
viper.SetConfigFile("config.toml")
viper.ReadInConfig()

// 读取覆盖配置文件（会覆盖主配置中的相同项）
viper.SetConfigFile("config.local.toml")
viper.MergeInConfig()
```

---

## 最佳实践

### 1. 配置文件管理

- ✅ 将 `config.toml` 添加到 `.gitignore`，避免提交敏感信息
- ✅ 提供 `config.toml.example` 作为配置模板
- ✅ 使用 `config_<env>.toml` 管理不同环境的配置

### 2. 敏感信息处理

- ✅ 敏感信息（密码、密钥）使用环境变量
- ✅ 生产环境配置不要提交到版本控制
- ✅ 使用配置管理工具（如 Vault、Consul）管理敏感配置

### 3. 配置验证

- ✅ 在应用启动时验证必需配置项
- ✅ 提供清晰的错误提示
- ✅ 使用配置默认值减少配置项

### 4. 多环境部署

```bash
# 开发环境
go run main.go -runmode=dev

# 测试环境
go run main.go -runmode=test

# 生产环境
go run main.go -runmode=prod
```

---

## 参考资源

- [Viper 官方文档](https://github.com/spf13/viper)
- [TOML 规范](https://toml.io/cn/)
- [Go embed 文档](https://pkg.go.dev/embed)

---

## 常见问题

### Q: 配置文件找不到怎么办？

A: 检查以下几点：
1. 确认配置文件在正确的路径下
2. 确认配置文件名称正确（`config.toml` 或 `config_<runmode>.toml`）
3. 确认当前工作目录是否正确
4. 如果文件系统找不到，会从嵌入的二进制文件中读取

### Q: 如何切换配置文件格式？

A: 修改 `conf/init.go` 中的配置：
```go
viper.SetConfigType("yaml") // 改为 yaml 格式
```

### Q: 环境变量如何命名？

A: 使用大写字母和下划线，嵌套配置用下划线连接：
- `MYSQL_DEFAULT_HOST`
- `REDIS_DEFAULT_PASSWORD`
- `SMTP_PORT`

### Q: 配置修改后需要重启吗？

A: 默认情况下需要重启。如需热重载，需要启用 `viper.WatchConfig()`。

